---
# Production environment setup playbook
# Installs only essential dependencies (no linters or dev tools)

- name: Setup Production Environment
  hosts: production
  become: true
  gather_facts: true

  roles:
    - role: common
      tags:
        - common
        - always

    - role: golang
      tags:
        - golang
        - always

  tasks:
    - name: Create project directory
      ansible.builtin.file:
        path: "{{ project_path }}"
        state: directory
        owner: "{{ project_user }}"
        group: "{{ _root_group | default('root') }}"
        mode: '0755'
      tags:
        - common

    - name: Create systemd service for exarp-go
      ansible.builtin.template:
        src: templates/exarp-go.service.j2
        dest: /etc/systemd/system/exarp-go.service
        owner: root
        group: "{{ _root_group | default('root') }}"
        mode: '0644'
      notify: Reload systemd
      when: ansible_system == "Linux"
      tags:
        - service
        - production

    - name: Display production environment summary
      ansible.builtin.debug:
        msg:
          - "âœ… Production environment setup complete"
          - "Go version: {{ go_version_resolved | default(go_version) }}"
          - "Project path: {{ project_path }}"
          - "Linters: Not installed (production)"
          - "GitHub CLI (gh): {{ 'Installed' if install_gh | default(false) else 'Not installed' }}"
      tags:
        - always

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
