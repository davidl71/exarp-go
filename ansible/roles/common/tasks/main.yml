---
# Common role - Base system setup

- name: Update package cache (Debian/Ubuntu)
  apt:
    update_cache: yes
    cache_valid_time: 3600
    fail_on_apt_warn: no
  ignore_errors: yes
  register: apt_update_result
  changed_when: false
  failed_when: false
  when: ansible_os_family == "Debian"

- name: Warn if apt update had issues
  debug:
    msg: "⚠️  Apt cache update had some issues (broken repositories detected). Continuing with available packages..."
  when: 
    - ansible_os_family == "Debian"
    - apt_update_result is defined
    - (apt_update_result.rc is defined and apt_update_result.rc != 0) or apt_update_result.failed | default(false)

- name: Update package cache (RedHat/CentOS)
  yum:
    update_cache: yes
  when: ansible_os_family == "RedHat"

- name: Install base packages
  package:
    name: "{{ item }}"
    state: present
  loop:
    - curl
    - wget
    - git
    - build-essential  # Debian/Ubuntu
    - gcc  # RedHat/CentOS
    - make
  loop_control:
    label: "{{ item }}"

- name: Install base packages (macOS)
  homebrew:
    name: "{{ item }}"
    state: present
  loop:
    - curl
    - wget
    - git
    - make
  when: ansible_system == "Darwin"
  loop_control:
    label: "{{ item }}"

- name: Get current user
  command: whoami
  register: current_user
  changed_when: false
  when: ansible_user is not defined

- name: Create project user
  user:
    name: "{{ project_user }}"
    state: present
    shell: /bin/bash
    create_home: yes
  when: 
    - project_user is defined
    - (ansible_user is defined and project_user != ansible_user) or (ansible_user is not defined and project_user != current_user.stdout)

- name: Create project directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ project_user }}"
    group: "{{ project_user }}"
    mode: '0755'
  loop:
    - "{{ project_path }}"
    - "{{ project_path }}/bin"
    - "{{ project_path }}/logs"
  loop_control:
    label: "{{ item }}"

##@ GitHub CLI (gh) - Optional installation

- name: Check if GitHub CLI (gh) is already installed
  command: gh --version
  register: gh_version_check
  changed_when: false
  failed_when: false
  ignore_errors: true
  when: install_gh | default(false)

- name: Check if GitHub CLI package is available in apt (Debian/Ubuntu)
  shell: apt-cache search ^gh$ 2>/dev/null | grep -q "^gh " || exit 1
  register: gh_apt_available
  changed_when: false
  failed_when: false
  ignore_errors: true
  when:
    - install_gh | default(false)
    - ansible_os_family == "Debian"
    - gh_version_check.rc != 0

- name: Install GitHub CLI via apt package (Debian/Ubuntu - if available in repos)
  apt:
    name: gh
    state: present
    update_cache: yes
  when:
    - install_gh | default(false)
    - ansible_os_family == "Debian"
    - gh_version_check.rc != 0
    - gh_apt_available is defined
    - gh_apt_available.rc == 0  # Only use if package is in default repos

- name: Install GitHub CLI via official apt repository (Debian/Ubuntu - fallback)
  shell: |
    type -p curl >/dev/null || (apt-get update && apt-get install curl -y)
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install gh -y
  args:
    creates: /usr/bin/gh
  when:
    - install_gh | default(false)
    - ansible_os_family == "Debian"
    - gh_version_check.rc != 0
    - gh_apt_available is defined
    - gh_apt_available.rc != 0  # Use fallback if package not in default repos

- name: Install GitHub CLI (RedHat/CentOS/Fedora)
  package:
    name: gh
    state: present
  when:
    - install_gh | default(false)
    - ansible_os_family in ["RedHat", "Suse"]
    - gh_version_check.rc != 0

- name: Install GitHub CLI (macOS)
  homebrew:
    name: gh
    state: present
  when:
    - install_gh | default(false)
    - ansible_system == "Darwin"
    - gh_version_check.rc != 0

- name: Verify GitHub CLI installation
  command: gh --version
  register: gh_verify
  changed_when: false
  failed_when: false
  ignore_errors: true
  when: install_gh | default(false)

- name: Display GitHub CLI installation status
  debug:
    msg: "GitHub CLI (gh): {{ gh_verify.stdout if (install_gh | default(false)) and gh_verify.rc == 0 else 'Not installed (set install_gh: true to install)' }}"

