---
# Golang role - Install and configure Go

- name: Load OS-specific variables
  ansible.builtin.include_vars: "{{ ansible_os_family }}.yml"
  tags: [golang]

- name: Set user home directory
  ansible.builtin.set_fact:
    _user_home: "{{ ansible_env.HOME if ansible_connection == 'local' else '/home/' + go_user }}"
  tags: [golang]

- name: Check if Go is already installed
  ansible.builtin.command: go version
  register: go_version_check
  changed_when: false
  failed_when: false
  tags: [golang]

- name: Set default resolved Go version
  ansible.builtin.set_fact:
    go_version_resolved: "{{ go_version }}"
  tags: [golang]

- name: Set Go download OS and architecture
  ansible.builtin.set_fact:
    go_dl_os: "{{ ansible_system | lower }}"
    go_dl_arch: "{{ {'x86_64': 'amd64', 'aarch64': 'arm64'}.get(ansible_architecture, ansible_architecture) }}"
  tags: [golang]

# Resolve latest stable version from go.dev (block/rescue for SSL fallback)
- name: Resolve latest Go version
  when: go_version == 'latest'
  tags: [golang]
  block:
    - name: Fetch latest Go version from go.dev
      ansible.builtin.uri:
        url: "https://go.dev/VERSION?m=text"
        return_content: true
        headers:
          Accept: "text/plain"
      register: go_latest_release

    - name: Set resolved Go version from go.dev
      ansible.builtin.set_fact:
        go_version_resolved: "{{ (go_latest_release.content | regex_findall('go([0-9]+\\.[0-9]+(?:\\.[0-9]+)?)') | first) | default(go_version_fallback) }}"

  rescue:
    # curl fallback — macOS Python SSL often fails against go.dev
    - name: Fallback — fetch Go version with curl
      ansible.builtin.command: curl -sSf https://go.dev/VERSION?m=text
      register: go_latest_curl
      changed_when: false
      failed_when: false

    - name: Set resolved Go version from curl
      ansible.builtin.set_fact:
        go_version_resolved: >-
          {{ (go_latest_curl.stdout | regex_findall('go([0-9]+\\.[0-9]+(?:\\.[0-9]+)?)') | first) | default(go_version_fallback)
             if go_latest_curl.rc == 0
             else go_version_fallback }}

- name: Set resolved Go version (pinned)
  ansible.builtin.set_fact:
    go_version_resolved: "{{ go_version }}"
  when: go_version != 'latest'
  tags: [golang]

- name: Display resolved Go version
  ansible.builtin.debug:
    msg: "Resolved Go version: {{ go_version_resolved }}"
  tags: [golang]

- name: Check whether Go needs (re)installing
  ansible.builtin.set_fact:
    _go_needs_install: >-
      {{ go_version_resolved != 'latest' and
         (go_version_check.rc != 0 or go_version_check.stdout is not search(go_version_resolved)) }}
  tags: [golang, install]

# Download Go (block/rescue for SSL fallback)
- name: Download Go tarball
  when: _go_needs_install | bool
  tags: [golang, install]
  block:
    - name: Download Go via get_url
      ansible.builtin.get_url:
        url: "https://go.dev/dl/go{{ go_version_resolved }}.{{ go_dl_os }}-{{ go_dl_arch }}.tar.gz"
        dest: /tmp/go.tar.gz
        mode: '0644'
  rescue:
    - name: Fallback — download Go with curl
      ansible.builtin.command: >
        curl -sSfL -o /tmp/go.tar.gz
        "https://go.dev/dl/go{{ go_version_resolved }}.{{ go_dl_os }}-{{ go_dl_arch }}.tar.gz"
      changed_when: true

- name: Remove old Go installation
  ansible.builtin.file:
    path: "{{ go_install_path }}"
    state: absent
  when: _go_needs_install | bool
  tags: [golang, install]

- name: Extract Go
  ansible.builtin.unarchive:
    src: /tmp/go.tar.gz
    dest: /usr/local
    remote_src: true
    owner: root
    group: "{{ _go_root_group }}"
  when: _go_needs_install | bool
  tags: [golang, install]

- name: Set Go environment variables (/etc/environment)
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    state: present
  loop:
    - {key: "GOROOT", value: "{{ go_install_path }}"}
    - {key: "GOPATH", value: "{{ go_gopath }}"}
    - {key: "PATH", value: "{{ go_install_path }}/bin:{{ go_bin_path }}:$PATH"}
  loop_control:
    label: "{{ item.key }}"
  when: _go_has_etc_environment
  tags: [golang, env]

- name: Set Go environment in user shell profile
  ansible.builtin.blockinfile:
    path: "{{ _user_home | default('/home/' + go_user) }}/{{ _go_shell_profile }}"
    block: |
      export GOROOT={{ go_install_path }}
      export GOPATH={{ go_gopath }}
      export PATH=$GOROOT/bin:$GOPATH/bin:$PATH
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Go environment"
    create: true
  when: go_user is defined
  tags: [golang, env]

- name: Verify Go installation
  ansible.builtin.command: go version
  register: go_verify
  changed_when: false
  tags: [golang]

- name: Display Go version
  ansible.builtin.debug:
    msg: "Go installed: {{ go_verify.stdout }}"
  tags: [golang]

# protoc is installed by the common role via _base_packages (protobuf-compiler / protobuf).
# Only protoc-gen-go (Go tool) needs to be installed here.

- name: Verify protoc installation (from common role)
  ansible.builtin.command: protoc --version
  register: protoc_verify
  changed_when: false
  failed_when: false
  tags: [golang, tools]

- name: Check if protoc-gen-go is already installed
  ansible.builtin.command: protoc-gen-go --version
  register: protoc_gen_go_check
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ go_bin_path }}:{{ lookup('env', 'PATH') }}"
  tags: [golang, tools]

- name: Install protoc-gen-go
  ansible.builtin.command: go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
  changed_when: true
  environment:
    PATH: "{{ go_bin_path }}:{{ lookup('env', 'PATH') }}"
    GOPATH: "{{ go_gopath }}"
  when: protoc_gen_go_check.rc != 0
  tags: [golang, tools]

- name: Verify protoc-gen-go installation
  ansible.builtin.command: protoc-gen-go --version
  register: protoc_gen_go_verify
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ go_bin_path }}:{{ lookup('env', 'PATH') }}"
  tags: [golang, tools]

- name: Display protoc-gen-go installation status
  ansible.builtin.debug:
    msg: >-
      protoc-gen-go:
      {{ protoc_gen_go_verify.stdout if protoc_gen_go_verify.rc == 0
      else 'Not installed (will be installed on first use)' }}
  tags: [golang, tools]
