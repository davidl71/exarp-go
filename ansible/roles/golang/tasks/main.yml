---
# Golang role - Install and configure Go

- name: Check if Go is already installed
  ansible.builtin.command: go version
  register: go_version_check
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: Get Go architecture
  ansible.builtin.set_fact:
    go_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"
  when: ansible_system == "Linux"

- name: Get Go architecture (macOS)
  ansible.builtin.set_fact:
    go_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"
  when: ansible_system == "Darwin"

- name: Download Go (Linux)
  ansible.builtin.get_url:
    url: "https://go.dev/dl/go{{ go_version }}.linux-{{ go_arch }}.tar.gz"
    dest: /tmp/go{{ go_version }}.tar.gz
    mode: '0644'
  when:
    - ansible_system == "Linux"
    - go_version_check.rc != 0 or go_version not in go_version_check.stdout

- name: Download Go (macOS)
  ansible.builtin.get_url:
    url: "https://go.dev/dl/go{{ go_version }}.darwin-{{ go_arch }}.pkg"
    dest: /tmp/go{{ go_version }}.pkg
    mode: '0644'
  when:
    - ansible_system == "Darwin"
    - go_version_check.rc != 0 or go_version not in go_version_check.stdout

- name: Remove existing Go installation (Linux)
  ansible.builtin.file:
    path: "{{ go_install_path }}"
    state: absent
  when:
    - ansible_system == "Linux"
    - go_version_check.rc != 0 or go_version not in go_version_check.stdout

- name: Extract Go archive (Linux)
  ansible.builtin.unarchive:
    src: /tmp/go{{ go_version }}.tar.gz
    dest: /usr/local
    remote_src: true
    owner: root
    group: root
  when:
    - ansible_system == "Linux"
    - go_version_check.rc != 0 or go_version not in go_version_check.stdout

- name: Install Go (macOS)  # noqa: command-instead-of-shell
  ansible.builtin.shell: installer -pkg /tmp/go{{ go_version }}.pkg -target /
  changed_when: false
  when:
    - ansible_system == "Darwin"
    - go_version_check.rc != 0 or go_version not in go_version_check.stdout

- name: Create Go workspace directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ go_user }}"
    group: "{{ go_user }}"
    mode: '0755'
  loop:
    - "{{ go_gopath }}"
    - "{{ go_gopath }}/bin"
    - "{{ go_gopath }}/src"
    - "{{ go_gopath }}/pkg"
  when: go_user is defined

- name: Set up Go environment variables
  ansible.builtin.lineinfile:
    path: "/home/{{ go_user }}/.bashrc"
    regexp: "^{{ item.regexp }}"
    line: "{{ item.line }}"
    create: true
    owner: "{{ go_user }}"
    group: "{{ go_user }}"
    mode: '0644'
  loop:
    - { regexp: "^export GOROOT=", line: "export GOROOT={{ go_install_path }}" }
    - { regexp: "^export GOPATH=", line: "export GOPATH={{ go_gopath }}" }
    - { regexp: "^export PATH=.*GOPATH", line: "export PATH=$PATH:$GOROOT/bin:$GOPATH/bin" }
  when: go_user is defined

- name: Verify Go installation
  ansible.builtin.command: "{{ go_install_path }}/bin/go version"
  register: go_verify
  changed_when: false

- name: Display Go version
  ansible.builtin.debug:
    msg: "Go {{ go_version }} installed successfully: {{ go_verify.stdout }}"
