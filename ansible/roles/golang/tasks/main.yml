---
# Golang role - Install and configure Go

- name: Check if Go is already installed
  command: go version
  register: go_version_check
  changed_when: false
  failed_when: false

# Ensure go_version_resolved is set (default to go_version; "latest" and "pinned" tasks override)
- name: Set default resolved Go version
  set_fact:
    go_version_resolved: "{{ go_version }}"

# Normalize OS/arch for go.dev/dl URLs (darwin/linux; amd64/arm64)
- name: Set Go download OS and architecture
  set_fact:
    go_dl_os: "{{ ansible_system | lower }}"
    go_dl_arch: "{{ {'x86_64': 'amd64', 'aarch64': 'arm64'}.get(ansible_architecture, ansible_architecture) }}"

# Resolve latest stable version from go.dev when go_version is "latest"
- name: Get latest stable Go version from go.dev (plain text)
  uri:
    url: "https://go.dev/VERSION?m=text"
    return_content: yes
    headers:
      Accept: "text/plain"
  register: go_latest_release
  when: go_version == 'latest'

- name: Set resolved Go version (latest)
  set_fact:
    go_version_resolved: "{{ (go_latest_release.content | regex_findall('go([0-9]+\\.[0-9]+(?:\\.[0-9]+)?)') | first) | default('1.25.6') }}"
  when: go_version == 'latest' and go_latest_release.content is defined

- name: Set resolved Go version (pinned)
  set_fact:
    go_version_resolved: "{{ go_version }}"
  when: go_version != 'latest'

- name: Download Go
  get_url:
    url: "https://go.dev/dl/go{{ go_version_resolved }}.{{ go_dl_os }}-{{ go_dl_arch }}.tar.gz"
    dest: /tmp/go.tar.gz
    mode: '0644'
  when: (go_version_check.rc != 0 or go_version_check.stdout is not search(go_version_resolved)) and go_version_resolved != 'latest'

- name: Remove old Go installation
  file:
    path: "{{ go_install_path }}"
    state: absent
  when: (go_version_check.rc != 0 or go_version_check.stdout is not search(go_version_resolved)) and go_version_resolved != 'latest'

- name: Extract Go
  unarchive:
    src: /tmp/go.tar.gz
    dest: /usr/local
    remote_src: yes
    owner: root
    group: root
  when: (go_version_check.rc != 0 or go_version_check.stdout is not search(go_version_resolved)) and go_version_resolved != 'latest'

- name: Set Go environment variables (Linux only; macOS has no /etc/environment)
  lineinfile:
    path: /etc/environment
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    state: present
  loop:
    - { key: "GOROOT", value: "{{ go_install_path }}" }
    - { key: "GOPATH", value: "{{ go_gopath }}" }
    - { key: "PATH", value: "{{ go_install_path }}/bin:{{ go_bin_path }}:$PATH" }
  loop_control:
    label: "{{ item.key }}"
  when: ansible_system != "Darwin"

- name: Set Go environment in user profile (Linux only; macOS uses /Users, not /home)
  blockinfile:
    path: "/home/{{ go_user }}/.bashrc"
    block: |
      export GOROOT={{ go_install_path }}
      export GOPATH={{ go_gopath }}
      export PATH=$GOROOT/bin:$GOPATH/bin:$PATH
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Go environment"
    create: yes
  when: go_user is defined and ansible_system != "Darwin"

- name: Set Go environment in zsh profile
  blockinfile:
    path: "/home/{{ go_user }}/.zshrc"
    block: |
      export GOROOT={{ go_install_path }}
      export GOPATH={{ go_gopath }}
      export PATH=$GOROOT/bin:$GOPATH/bin:$PATH
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Go environment"
    create: yes
  when: go_user is defined and ansible_system != "Darwin"

- name: Verify Go installation (use system go so it works when Go is from Homebrew or role path)
  command: go version
  register: go_verify
  changed_when: false

- name: Display Go version
  debug:
    msg: "Go installed: {{ go_verify.stdout }}"

# Install protoc (Protocol Buffers compiler) â€” required for make proto (exarp-go .proto codegen)
- name: Install protoc (Debian/Ubuntu)
  apt:
    name: protobuf-compiler
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

- name: Install protoc (macOS)
  homebrew:
    name: protobuf
    state: present
  when: ansible_system == "Darwin"

- name: Verify protoc installation
  command: protoc --version
  register: protoc_verify
  changed_when: false
  failed_when: false

# Install protoc-gen-go (Go protobuf code generator)
- name: Check if protoc-gen-go is already installed
  command: protoc-gen-go --version
  register: protoc_gen_go_check
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ go_bin_path }}:{{ lookup('env', 'PATH') }}"

- name: Install protoc-gen-go (use system go so it works when Go is from Homebrew or role path)
  command: go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
  environment:
    PATH: "{{ go_bin_path }}:{{ lookup('env', 'PATH') }}"
    GOPATH: "{{ go_gopath }}"
  when: protoc_gen_go_check.rc != 0

- name: Verify protoc-gen-go installation
  command: protoc-gen-go --version
  register: protoc_gen_go_verify
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ go_bin_path }}:{{ lookup('env', 'PATH') }}"

- name: Display protoc-gen-go installation status
  debug:
    msg: >-
      protoc-gen-go:
      {{ protoc_gen_go_verify.stdout if protoc_gen_go_verify.rc == 0
      else 'Not installed (will be installed on first use)' }}
