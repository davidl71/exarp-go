---
# Python role - Install Python, uv, Node.js
# Unified local/remote handling via _user_home fact

- name: Set user home directory
  set_fact:
    _user_home: "{{ ansible_env.HOME if ansible_connection == 'local' else '/home/' + project_user }}"
    _shell_rc: "{{ ansible_env.HOME if ansible_connection == 'local' else '/home/' + project_user }}/.{{ 'zshrc' if ansible_system == 'Darwin' else 'bashrc' }}"

- name: Check Python version
  command: python3 --version
  register: python_version_check
  changed_when: false
  failed_when: false

- name: Install Python (Debian/Ubuntu)
  apt:
    name: [python3, python3-pip, python3-venv]
    state: present
  when: ansible_os_family == "Debian"

- name: Install Python (RedHat/CentOS)
  yum:
    name: [python3, python3-pip]
    state: present
  when: ansible_os_family == "RedHat"

- name: Install Python (macOS)
  homebrew:
    name: "python@{{ python_version }}"
    state: present
  when: ansible_system == "Darwin"

- name: Upgrade pip
  pip:
    name: pip
    state: latest
    executable: pip3

# --- Parallel installs: uv + Node.js ---

- name: Install uv (async)
  shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: "{{ _user_home }}/.local/bin/uv"
  async: 120
  poll: 0
  register: uv_job

- name: Install Node.js (Debian/Ubuntu)
  apt:
    name: nodejs
    state: present
  when: ansible_os_family == "Debian"

- name: Install Node.js (RedHat/CentOS)
  yum:
    name: nodejs
    state: present
  when: ansible_os_family == "RedHat"

- name: Install Node.js (macOS)
  homebrew:
    name: node
    state: present
  when: ansible_system == "Darwin"

- name: Wait for uv install
  async_status:
    jid: "{{ uv_job.ansible_job_id }}"
  register: uv_result
  until: uv_result.finished
  retries: 12
  delay: 10
  when: uv_job.ansible_job_id is defined

# --- PATH setup (unified, no local/remote duplication) ---

- name: Add uv to PATH
  lineinfile:
    path: "{{ _shell_rc }}"
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    regexp: '^export PATH=.*\.local/bin'
    state: present
    create: yes

- name: Add npm global bin to PATH
  blockinfile:
    path: "{{ _shell_rc }}"
    block: |
      export PATH="$HOME/.npm-global/bin:$PATH"
      [ -s "$HOME/.nvm/nvm.sh" ] && export PATH="$HOME/.nvm/versions/node/$(nvm version)/bin:$PATH"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - npm PATH"
    create: yes

# --- Verify ---

- name: Verify Python installation
  command: python3 --version
  register: python_verify
  changed_when: false

- name: Verify pip installation
  command: pip3 --version
  register: pip_verify
  changed_when: false

- name: Display Python environment
  debug:
    msg:
      - "Python: {{ python_verify.stdout }}"
      - "pip: {{ pip_verify.stdout }}"
      - "Shell RC: {{ _shell_rc }}"

