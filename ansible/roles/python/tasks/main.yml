---
# Python role - Install Python and package managers

- name: Check Python version
  command: python3 --version
  register: python_version_check
  changed_when: false
  failed_when: false

- name: Install Python (Debian/Ubuntu)
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
    state: present
  when: ansible_facts['ansible_os_family'] == "Debian"

- name: Install Python (RedHat/CentOS)
  yum:
    name:
      - python3
      - python3-pip
    state: present
  when: ansible_facts['ansible_os_family'] == "RedHat"

- name: Install Python (macOS)
  homebrew:
    name: python@{{ python_version }}
    state: present
  when: ansible_system == "Darwin"

- name: Upgrade pip
  pip:
    name: pip
    state: latest
    executable: pip3

- name: Install uv (Python package manager)
  shell: |
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: /home/{{ project_user }}/.local/bin/uv
  when: ansible_connection != "local"

- name: Install uv (local)
  shell: |
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: "{{ ansible_env.HOME }}/.local/bin/uv"
  when: ansible_connection == "local"

- name: Add uv to PATH
  lineinfile:
    path: "/home/{{ project_user }}/.bashrc"
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    regexp: '^export PATH=.*\.local/bin'
    state: present
  when: ansible_connection != "local"

- name: Add uv to PATH (local)
  lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    regexp: '^export PATH=.*\.local/bin'
    state: present
  when: ansible_connection == "local"

- name: Add npm global bin to PATH
  blockinfile:
    path: "/home/{{ project_user }}/.bashrc"
    block: |
      # Add npm global bin to PATH
      export PATH="$HOME/.npm-global/bin:$PATH"
      # Add nvm node bin to PATH (if using nvm)
      [ -s "$HOME/.nvm/nvm.sh" ] && export PATH="$HOME/.nvm/versions/node/$(nvm version)/bin:$PATH"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - npm PATH"
    create: yes
  when: ansible_connection != "local"

- name: Add npm global bin to PATH (local)
  blockinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    block: |
      # Add npm global bin to PATH
      export PATH="$HOME/.npm-global/bin:$PATH"
      # Add nvm node bin to PATH (if using nvm)
      [ -s "$HOME/.nvm/nvm.sh" ] && export PATH="$HOME/.nvm/versions/node/$(nvm version)/bin:$PATH"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - npm PATH"
    create: yes
  when: ansible_connection == "local"

- name: Install Node.js and npm (for MCP servers)
  block:
    - name: Install Node.js (Debian/Ubuntu)
      apt:
        name: nodejs
        state: present
      when: ansible_facts['ansible_os_family'] == "Debian"

    - name: Install Node.js (RedHat/CentOS)
      yum:
        name: nodejs
        state: present
      when: ansible_facts['ansible_os_family'] == "RedHat"

    - name: Install Node.js (macOS)
      homebrew:
        name: node
        state: present
      when: ansible_system == "Darwin"

- name: Verify Python installation
  command: python3 --version
  register: python_verify
  changed_when: false

- name: Verify pip installation
  command: pip3 --version
  register: pip_verify
  changed_when: false

- name: Display Python environment
  debug:
    msg:
      - "Python: {{ python_verify.stdout }}"
      - "pip: {{ pip_verify.stdout }}"

