---
# Linters role - Install optional linters and code quality tools
# Phase 0: batch system packages (shellcheck, yamllint, ansible-lint, actionlint, Node.js) in one apt/dnf/brew call.
# Phase 1: fire off Go/npm tool installs in parallel (async).
# Phase 2: wait for async jobs (failures are tolerated — linters are optional).
# Phase 3: verify.

- name: Load OS-specific variables
  ansible.builtin.include_vars: "{{ ansible_os_family }}.yml"
  tags: [linters, optional]

# --- Phase 0: System packages (shellcheck, yamllint, ansible-lint, actionlint, Node.js) — one batched install per OS ---

- name: Build system package list from enabled linters
  ansible.builtin.set_fact:
    _linter_sys_pkgs: >-
      {{ ([ _shellcheck_pkg ] if 'shellcheck' in linters else []) +
         ([ _yamllint_pkg ] if 'yamllint' in linters else []) +
         ([ _universal_ctags_pkg ] if ('universal-ctags' in linters and _universal_ctags_pkg is defined) else []) +
         ([ _ansible_lint_pkg ] if ('ansible-lint' in linters and _ansible_lint_pkg is defined) else []) +
         ([ _actionlint_pkg ] if ('actionlint' in linters and _actionlint_pkg is defined) else []) +
         ([ _nodejs_pkg ]     if ('markdownlint-cli' in linters or 'cspell' in linters) else []) +
         ([ _cppcheck_pkg ]   if ('cppcheck' in linters and _cppcheck_pkg is defined) else []) +
         ([ _clang_tidy_pkg ] if ('clang-tidy' in linters and _clang_tidy_pkg is defined) else []) +
         ([ _ruff_pkg ]       if ('ruff' in linters and ansible_system == 'Darwin' and _ruff_pkg is defined) else []) +
         ([ _chktex_pkg ]     if ('chktex' in linters and _chktex_pkg is defined) else []) +
         ([ _lacheck_pkg ]    if ('lacheck' in linters and _lacheck_pkg is defined) else []) }}
  tags: [linters, optional]

- name: Install system linter packages
  ansible.builtin.package:
    name: "{{ _linter_sys_pkgs }}"
    state: present
  when:
    - _linter_sys_pkgs | length > 0
    - ansible_system == "Linux"
  tags: [linters, optional]

- name: Install system linter packages (Homebrew)
  community.general.homebrew:
    name: "{{ _linter_sys_pkgs }}"
    state: present
  when:
    - _linter_sys_pkgs | length > 0
    - ansible_system == "Darwin"
  tags: [linters, optional]

- name: Install ansible-lint (pip) on Linux
  ansible.builtin.pip:
    name: ansible-lint
    state: present
    executable: pip3
  when:
    - "'ansible-lint' in linters"
    - ansible_system == "Linux"
  tags: [linters, optional]

- name: Install ruff (pip) on Linux
  ansible.builtin.pip:
    name: ruff
    state: present
    executable: pip3
  when:
    - "'ruff' in linters"
    - ansible_system == "Linux"
  tags: [linters, optional]

# --- Phase 1: Fire off async installs (all independent) ---

# golangci-lint official install uses curl | sh — pipefail set for safety.
- name: Install golangci-lint (async)
  ansible.builtin.shell: |
    set -o pipefail
    curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b {{ go_bin_path }} latest
  args:
    creates: "{{ go_bin_path }}/golangci-lint"
    executable: /bin/bash
  async: 300
  poll: 0
  register: golangci_job
  when: "'golangci-lint' in linters"
  tags: [linters, optional]

- name: Install Go-based linters (async)
  ansible.builtin.command: "go install {{ item.pkg }}"
  environment:
    GOPATH: "{{ go_gopath }}"
    PATH: "{{ go_install_path }}/bin:{{ go_bin_path }}:{{ ansible_env.PATH }}"
  args:
    creates: "{{ go_bin_path }}/{{ item.bin }}"
  async: 300
  poll: 0
  register: go_linter_jobs
  loop:
    - {name: "gomarklint", bin: "gomarklint", pkg: "github.com/shinagawa-web/gomarklint@latest"}
    - {name: "shfmt", bin: "shfmt", pkg: "mvdan.cc/sh/v3/cmd/shfmt@latest"}
    - {name: "govulncheck", bin: "govulncheck", pkg: "golang.org/x/vuln/cmd/govulncheck@latest"}
    - {name: "deadcode", bin: "deadcode", pkg: "golang.org/x/tools/cmd/deadcode@latest"}
  loop_control:
    label: "{{ item.name }}"
  when: "item.name in linters"
  tags: [linters, optional]

- name: Install PHP linters via Composer (async)
  ansible.builtin.shell: |
    composer global require {{ item.pkg }}
  args:
    executable: /bin/bash
  async: 120
  poll: 0
  register: composer_linter_jobs
  loop:
    - {name: "phpcs", pkg: "squizlabs/php_codesniffer"}
    - {name: "phpstan", pkg: "phpstan/phpstan"}
    - {name: "php-cs-fixer", pkg: "friendsofphp/php-cs-fixer"}
  loop_control:
    label: "{{ item.name }}"
  when: "item.name in linters"
  tags: [linters, optional]

- name: Install Rust linter components via rustup (async)
  ansible.builtin.shell: |
    rustup component add clippy rustfmt
  args:
    executable: /bin/bash
  async: 120
  poll: 0
  register: rustup_job
  when: "'clippy' in linters or 'rustfmt' in linters"
  tags: [linters, optional]

- name: Install npm-based linters (async)
  ansible.builtin.command: "npm install -g {{ item.pkg }}"
  args:
    creates: "{{ _npm_global_bin | default('/usr/local/bin') }}/{{ item.bin }}"
  async: 120
  poll: 0
  register: npm_linter_jobs
  loop:
    - {name: "markdownlint-cli", bin: "markdownlint", pkg: "markdownlint-cli"}
    - {name: "cspell", bin: "cspell", pkg: "cspell"}
  loop_control:
    label: "{{ item.name }}"
  when: "item.name in linters"
  tags: [linters, optional]

# --- Phase 2: Wait for async jobs (failures tolerated — linters are optional) ---

- name: Wait for golangci-lint install
  ansible.builtin.async_status:
    jid: "{{ golangci_job.ansible_job_id }}"
  register: golangci_result
  until: golangci_result.finished
  retries: 30
  delay: 10
  failed_when: false
  when: golangci_job is not skipped and golangci_job.ansible_job_id is defined
  tags: [linters, optional]

- name: Wait for Go-based linter installs
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ go_linter_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name | default('unknown') }}"
  register: go_linter_results
  until: go_linter_results.finished
  retries: 30
  delay: 10
  failed_when: false
  when: item.ansible_job_id is defined
  tags: [linters, optional]

- name: Wait for Rust component installs
  ansible.builtin.async_status:
    jid: "{{ rustup_job.ansible_job_id }}"
  register: rustup_result
  until: rustup_result.finished
  retries: 12
  delay: 10
  failed_when: false
  when: rustup_job is not skipped and rustup_job.ansible_job_id is defined
  tags: [linters, optional]

- name: Wait for PHP Composer linter installs
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ composer_linter_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name | default('unknown') }}"
  register: composer_linter_results
  until: composer_linter_results.finished
  retries: 12
  delay: 10
  failed_when: false
  when: item.ansible_job_id is defined
  tags: [linters, optional]

- name: Wait for npm-based linter installs
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ npm_linter_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name | default('unknown') }}"
  register: npm_linter_results
  until: npm_linter_results.finished
  retries: 12
  delay: 10
  failed_when: false
  when: item.ansible_job_id is defined
  tags: [linters, optional]

# --- Phase 3: Verify ---

- name: Verify linter installations
  ansible.builtin.command: "{{ item.command }} {{ item.version_flag | default('--version') }}"
  register: linter_versions
  changed_when: false
  failed_when: false
  loop:
    - {name: "golangci-lint", command: "{{ go_bin_path }}/golangci-lint"}
    - {name: "govulncheck", command: "{{ go_bin_path }}/govulncheck"}
    - {name: "gomarklint", command: "{{ go_bin_path }}/gomarklint"}
    - {name: "deadcode", command: "{{ go_bin_path }}/deadcode"}
    - {name: "shellcheck", command: "shellcheck"}
    - {name: "shfmt", command: "{{ go_bin_path }}/shfmt"}
    - {name: "yamllint", command: "yamllint"}
    - {name: "universal-ctags", command: "ctags", version_flag: "--version"}
    - {name: "ansible-lint", command: "ansible-lint"}
    - {name: "actionlint", command: "actionlint"}
    - {name: "markdownlint-cli", command: "markdownlint"}
    - {name: "cspell", command: "cspell"}
    - {name: "clang-tidy", command: "clang-tidy"}
    - {name: "cppcheck", command: "cppcheck"}
    - {name: "ruff", command: "ruff"}
    - {name: "clippy", command: "rustup", version_flag: "component list --installed"}
    - {name: "rustfmt", command: "rustfmt"}
    - {name: "phpcs", command: "phpcs"}
    - {name: "phpstan", command: "phpstan"}
    - {name: "php-cs-fixer", command: "php-cs-fixer"}
    - {name: "chktex", command: "chktex", version_flag: "-v"}
    - {name: "lacheck", command: "lacheck"}
  when: item.name in linters
  tags: [linters, optional]

- name: Display installed linters
  ansible.builtin.debug:
    msg: "{{ item.item.name }}: {{ item.stdout | default('not installed') }}"
  loop: "{{ linter_versions.results | default([]) }}"
  when: item.rc is defined and item.rc == 0
  loop_control:
    label: "{{ item.item.name | default('unknown') }}"
  tags: [linters, optional]
