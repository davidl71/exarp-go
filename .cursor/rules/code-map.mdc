---
description: Maps MCP tools and packages to their implementation files
alwaysApply: true
---

# Code Map — Where Things Live

Use this map to jump directly to the right file when working on a tool, feature, or package.

## MCP Tool → Handler File

| Tool | Handler file(s) | Key actions |
|------|-----------------|-------------|
| `task_workflow` | `task_workflow_native.go` → `task_workflow_common.go` | sync, create, update, delete, approve, cleanup, sanity, clarify, summarize, run_with_ai |
| `task_analysis` | `task_analysis_shared.go` | parallelization, dependencies, duplicates, conflicts, execution_plan, tags, suggest_deps, stale, completable |
| `report` | `report.go` | overview, scorecard, briefing, plan, parallel_execution_plan, update_waves_from_plan, prd |
| `session` | `session.go` | prime, handoff (end/list/resume/latest/export/close/approve) |
| `health` | `health_check.go` | server, git, docs, dod, cicd, tools, ctags |
| `task_discovery` | `task_discovery_native.go` / `_nocgo.go`, `task_discovery_common.go` | comments, markdown, orphans, git_json, planning_links, all |
| `lint` | `linting.go` | run, analyze |
| `security` | `security.go` | scan |
| `memory` | `memory.go` | store, recall, search, list, forget |
| `memory_maint` | `memory_maint.go` | health, gc, prune, consolidate, dream |
| `testing` | `testing.go` | validate, run, coverage |
| `automation` | `automation_native.go` | sprint_start, sprint_end, pre_sprint |
| `workflow_mode` | `workflow_mode.go` | get, set, suggest |
| `infer_task_progress` | `infer_task_progress.go` | (single action, evidence in `infer_task_progress_evidence.go`) |
| `estimation` | `estimation_native.go` / `_nocgo.go`, `estimation_shared.go` | estimate, batch |
| `generate_config` | `config_generator.go` | init, export, convert |
| `analyze_alignment` | `alignment_analysis.go` | todo2, prd |
| `git_tools` | `git_tools.go` | commits, branches, tasks, diff, graph, merge, set_branch |
| `ollama` | `ollama_native.go`, `ollama_provider.go` | status, models, generate, pull, hardware, docs, quality, summary |
| `mlx` | `mlx_native_nocgo.go`, `mlx_provider.go`, `mlx_invoke.go` | status, hardware, models, generate |
| `apple_foundation_models` | `apple_foundation_registry.go`, `fm_plan_execute.go` | status, hardware, models, generate, respond, summarize, classify |
| `text_generate` | `text_generate.go`, `model_router.go` | (single action, provider=auto/fm/ollama/mlx/localai) |
| `context` | `context.go`, `context_native.go` / `_nocgo.go` | summarize, batch |
| `context_budget` | `context.go` | (budget calculation) |
| `tool_catalog` | `tool_catalog.go` | help |
| `setup_hooks` | `hooks_setup.go` | (single action) |
| `check_attribution` | `attribution_check.go` | (single action) |
| `add_external_tool_hints` | `external_tool_hints.go` | (single action) |
| `recommend` | `recommend.go` | model, workflow, advisor |
| `research_aggregator` | `research_aggregator.go` | (single action) |
| `infer_session_mode` | `session_mode_inference.go` | (single action) |
| `prompt_tracking` | `prompt_tracking.go` | log, list, stats |
| `task_execute` | `task_execute.go` | (single action) |
| `cursor_cloud_agent` | `cursor_cloud_agent.go` | (single action) |
| `fm_plan_and_execute` | `fm_plan_execute.go` | plan, execute, status |

All handler files are in `internal/tools/`. Registration is in `registry.go` (3 batches: `registerBatch1Tools`, `registerBatch2Tools`, `registerBatch3Tools`).

## Package Responsibilities

| Package | Purpose | Key files |
|---------|---------|-----------|
| `cmd/server` | Entry point: CLI dispatch or MCP stdio server | `main.go` |
| `internal/cli` | CLI subcommands + Bubbletea TUI + 3270 TUI | `cli.go` (dispatch), `tui*.go` (14 files), `tui3270.go`, `task.go`, `child_agent.go` |
| `internal/tools` | All MCP tool handlers (business logic) | See tool map above; `handlers.go` (top-level dispatch) |
| `internal/database` | SQLite storage for tasks, comments, activities, locks | `tasks.go` (CRUD), `schema.go` (constants), `locking.go`, `migrations/` |
| `internal/models` | Shared types and constants (no DB dependency) | `todo2.go` (Todo2Task struct), `constants.go` (status/priority), `task_id.go` |
| `internal/config` | Protobuf-based project configuration | `schema.go` (FullConfig), `loader.go`, `writer.go` |
| `internal/framework` | MCP server interface abstraction | `server.go` (MCPServer interface), `types.go` |
| `internal/factory` | Framework factory (creates MCPServer instances) | `factory.go` |
| `internal/resources` | MCP resource handlers (stdio:// URIs) | `handlers.go` (registry), `tasks.go`, `tools.go`, `session.go` |
| `internal/prompts` | MCP prompt definitions | `registry.go` |
| `internal/cache` | File-based caching (scorecard, reports) | `file_cache.go` |
| `internal/queue` | Redis+Asynq job queue for wave execution | `producer.go`, `worker.go`, `config.go` |
| `internal/security` | Rate limiting, path validation, vuln scanning | `ratelimit.go`, `scanner.go` |
| `internal/logging` | Structured logging (slog) | `logger.go` |

## Data Flow

```
CLI request or MCP JSON-RPC
  → cmd/server/main.go (detect mode)
    → CLI: internal/cli/cli.go → subcommand handlers
    → MCP: framework.MCPServer.Serve() → internal/tools/handlers.go
      → tool-specific handler (e.g. report.go)
        → internal/database (task CRUD)
        → internal/config (project settings)
        → response back via framework
```
