name: Go CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Go Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      # Taskfile equivalent: task test (or task test:coverage for coverage)
      - name: Run tests
        run: go test -v -coverprofile=coverage.out -coverpkg=./internal/... ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: go
          name: go-coverage

  lint:
    name: Go Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      # Taskfile equivalent: task lint:golangci
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  vet:
    name: Go Vet
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      # Taskfile equivalent: task vet
      - name: Run go vet
        run: go vet ./...

      # Taskfile equivalent: task fmt (run to fix; CI only checks)
      - name: Run go fmt check
        run: |
          if [ "$(gofmt -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted. Run 'go fmt ./...'"
            gofmt -l .
            exit 1
          fi

  build:
    name: Go Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      # Taskfile equivalent: task build
      - name: Build
        run: go build -o bin/exarp-go ./cmd/server

      - name: Full handoff export
        run: |
          ./bin/exarp-go -tool session -args '{"action":"handoff","sub_action":"end","summary":"CI handoff","include_tasks":true,"include_point_in_time_snapshot":true}'
          ./bin/exarp-go -tool session -args '{"action":"handoff","sub_action":"export","output_path":"docs/CI_HANDOFF.json","export_latest":true}'

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: exarp-go-binary
          path: bin/exarp-go
          retention-days: 7

      - name: Upload CI handoff
        uses: actions/upload-artifact@v4
        with:
          name: ci-handoff
          path: docs/CI_HANDOFF.json
          retention-days: 7

  security:
    name: Go Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      # Taskfile equivalent: task govulncheck
      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
  pre-release:
    name: Pre-release (full)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      # Taskfile equivalent: task pre-release
      - name: Run pre-release
        run: make pre-release

      - name: Upload pre-release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pre-release-artifacts
          path: |
            bin/exarp-go
            docs/CI_HANDOFF.json
          retention-days: 14

  module-check:
    name: Go Module Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Verify go.mod
        run: |
          if [ ! -f go.mod ]; then
            echo "Error: go.mod not found"
            exit 1
          fi

      - name: Verify go.sum
        run: |
          if [ ! -f go.sum ]; then
            echo "Error: go.sum not found"
            exit 1
          fi

      # Taskfile equivalent: task tidy
      - name: Run go mod tidy
        run: go mod tidy

      - name: Check for changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Error: go.mod or go.sum changed. Run 'go mod tidy' and commit changes."
            git diff
            exit 1
          fi

  lint-extras:
    name: Shellcheck, yamllint, ansible-lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install linters
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq shellcheck yamllint
          pip install --quiet ansible-lint

      - name: Run shellcheck
        run: shellcheck -x scripts/*.sh ansible/run-dev-setup.sh

      - name: Run yamllint
        run: yamllint -f standard .github ansible

      - name: Run ansible-lint
        run: cd ansible && ansible-lint --format=pep8

  scorecard:
    name: Go Scorecard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      # Taskfile equivalent: task exarp:scorecard (requires build; uses binary)
      - name: Generate Go scorecard
        run: |
          go run ./cmd/server -tool report -args '{"action":"scorecard","include_metrics":true}'

