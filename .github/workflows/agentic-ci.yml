name: Agentic Development CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Job 1: Build exarp-go binary (required for other jobs)
  build:
    name: Build exarp-go
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      # Taskfile equivalent: task build
      - name: Build exarp-go
        run: go build -o bin/exarp-go ./cmd/server

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: exarp-go-binary
          path: bin/exarp-go
          retention-days: 7

  # Job 2: Agent validation using exarp-go tools (immediate, no dependencies)
  agent-validation:
    name: Agent Validation (exarp-go)
    runs-on: self-hosted  # Use self-hosted runners if available, falls back to ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Download exarp-go binary
        uses: actions/download-artifact@v8
        with:
          name: exarp-go-binary
          path: bin/

      - name: Make binary executable
        run: chmod +x bin/exarp-go

      - name: Validate MCP Tools
        run: |
          echo "Validating exarp-go MCP tools..."
          ./bin/exarp-go -test tool_workflow || true
          ./bin/exarp-go -test automation || true
          ./bin/exarp-go -test testing || true

      - name: Test Agent Behavior
        run: |
          echo "Testing agent behavior with exarp-go tools..."
          ./bin/exarp-go -tool testing \
            -args '{"action":"validate","test_path":"./internal/tools","framework":"go"}' || true

      - name: Check Todo2 Integration
        run: |
          echo "Checking Todo2 integration..."
          ./bin/exarp-go -tool task_workflow \
            -args '{"action":"sync"}' || true

      - name: Todo2 task sanity check
        run: |
          echo "Running Todo2 task sanity check..."
          ./bin/exarp-go -tool task_workflow -args '{"action":"sanity_check"}'

      - name: Generate Agent Report
        run: |
          echo "Generating agent evaluation report..."
          ./bin/exarp-go -tool report \
            -args '{"action":"overview","include_metrics":true,"output_format":"json","compact":true}' > agent_report.txt || true
          cat agent_report.txt

      # Makefile-only: context-token-metrics (no Taskfile equivalent yet)
      - name: Context token metrics (token_estimate from report/session)
        run: |
          make context-token-metrics || true

      # Makefile-only: context-token-check (no Taskfile equivalent yet)
      - name: Context token budget check (optional)
        run: |
          # Fail if token_estimate exceeds limit (set in env or default 20000). 0 = skip.
          make context-token-check TOKEN_BUDGET_LIMIT=$${TOKEN_BUDGET_LIMIT:-20000} || true

      - name: Full handoff export
        run: |
          ./bin/exarp-go -tool session -args '{"action":"handoff","sub_action":"end","summary":"Agentic CI handoff","include_tasks":true,"include_point_in_time_snapshot":true}'
          ./bin/exarp-go -tool session -args '{"action":"handoff","sub_action":"export","output_path":"docs/CI_HANDOFF.json","export_latest":true}'

      - name: Upload Agent Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-validation-report
          path: agent_report.txt
          retention-days: 7

      - name: Upload CI handoff
        uses: actions/upload-artifact@v4
        with:
          name: ci-handoff
          path: docs/CI_HANDOFF.json
          retention-days: 7

  # Job 3: Combined validation (exarp-go validation only; AgentScope evaluation removed 2026-01-29)
  combined-validation:
    name: Combined Agent Validation
    runs-on: self-hosted
    needs: [build, agent-validation]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download validation reports
        uses: actions/download-artifact@v8
        with:
          path: validation_reports/

      - name: Combine Reports
        run: |
          echo "=== Combined Agent Validation Report ===" > combined_report.txt
          echo "" >> combined_report.txt
          echo "=== exarp-go Validation ===" >> combined_report.txt
          cat validation_reports/agent-validation-report/agent_report.txt >> combined_report.txt || echo "No exarp-go report" >> combined_report.txt
          cat combined_report.txt

      - name: Upload Combined Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: combined-agent-validation-report
          path: combined_report.txt
          retention-days: 7
